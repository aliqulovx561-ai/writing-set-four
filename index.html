<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IELTS Writing Test - Set Four</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      line-height: 1.6;
    }
    
    /* Rules Screen */
    #rulesScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .rules-container {
      background: white;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    
    .rules-container h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2.2em;
    }
    
    .rules-container h2 {
      color: #34495e;
      margin: 25px 0 15px 0;
      border-bottom: 2px solid #3498db;
      padding-bottom: 5px;
    }
    
    .rules-container ul {
      margin: 15px 0;
      padding-left: 25px;
    }
    
    .rules-container li {
      margin-bottom: 8px;
    }
    
    .warning-box {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-left: 4px solid #f39c12;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .teacher-selection, .name-input {
      background: #e8f4f8;
      border: 2px solid #3498db;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }
    
    .radio-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    
    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 10px 15px;
      background: white;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      transition: all 0.3s ease;
    }
    
    .radio-label:hover {
      border-color: #3498db;
      transform: translateY(-2px);
    }
    
    .radio-label input[type="radio"] {
      margin-right: 8px;
    }
    
    .radio-label input[type="radio"]:checked + span {
      font-weight: bold;
      color: #3498db;
    }
    
    .name-input input {
      width: 100%;
      padding: 12px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      font-size: 16px;
      margin-top: 8px;
      transition: border-color 0.3s ease;
    }
    
    .name-input input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .start-button {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      transition: all 0.3s ease;
    }
    
    .start-button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    
    .start-button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
    }
    
    /* Test Container */
    #testContainer {
      display: none;
    }
    
    .test-info {
      background: #3498db;
      color: white;
      padding: 15px 30px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .header {
      background: white;
      padding: 15px 30px;
      border-bottom: 1px solid #ecf0f1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .student-name-display {
      font-weight: bold;
      color: #2c3e50;
    }
    
    .top-right-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }
    
    .timer-display {
      background: #2c3e50;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 16px;
      min-width: 80px;
      text-align: center;
    }
    
    .timer-display.warning {
      background: #e74c3c;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .violation-counter {
      background: #f39c12;
      color: white;
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .violation-counter.warning {
      background: #e74c3c;
    }
    
    .header img {
      height: 35px;
    }
    
    .part-bar {
      background: #ecf0f1;
      padding: 15px 30px;
      border-bottom: 1px solid #bdc3c7;
      color: #2c3e50;
      font-weight: 500;
    }
    
    .main {
      display: flex;
      height: calc(100vh - 200px);
      background: white;
    }
    
    .left, .right {
      padding: 25px;
      overflow-y: auto;
    }
    
    .left {
      width: 50%;
      border-right: 3px solid #bdc3c7;
      background: #f8f9fa;
    }
    
    .right {
      width: 50%;
      background: white;
    }
    
    .task-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .task-content p {
      margin-bottom: 15px;
    }
    
    .task-instructions {
      color: #7f8c8d;
      font-style: italic;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      border-left: 3px solid #3498db;
    }
    
    .image-container img {
      width: 100%;
      height: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    textarea {
      width: 100%;
      height: 100%;
      border: 2px solid #ecf0f1;
      border-radius: 8px;
      padding: 15px;
      font-size: 16px;
      line-height: 1.6;
      resize: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: border-color 0.3s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    textarea:disabled {
      background: #f8f9fa;
      color: #7f8c8d;
    }
    
    .word-count {
      text-align: right;
      margin-top: 10px;
      font-size: 14px;
      color: #7f8c8d;
    }
    
    .word-count.warning {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .typing-speed {
      text-align: right;
      font-size: 12px;
      color: #95a5a6;
      margin-top: 2px;
    }
    
    .typing-speed.warning {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .tab-buttons {
      display: flex;
      background: #34495e;
    }
    
    .tab-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      background: #2c3e50;
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .tab-buttons button.active {
      background: #3498db;
    }
    
    .tab-buttons button:hover:not(.active) {
      background: #34495e;
    }
    
    .submit-btn, .review-btn {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      margin: 20px auto;
      display: block;
      transition: all 0.3s ease;
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
    }
    
    .submit-btn:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    
    .review-btn {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
    }
    
    .review-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #3498db;
      font-size: 16px;
      display: none;
    }
    
    .submission-confirmation {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 30px;
      text-align: center;
      display: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    
    .modal h2 {
      color: #e74c3c;
      margin-bottom: 15px;
    }
    
    .modal p {
      margin: 15px 0;
      line-height: 1.6;
    }
    
    .modal button {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .modal button:hover {
      background: #c0392b;
    }
  </style>
</head>
<body>

  <!-- Rules Screen -->
  <div id="rulesScreen">
    <div class="rules-container">
      <h1>IELTS Writing Test - Set Four</h1>
      <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">Complete both writing tasks within 60 minutes</p>
      
      <h2>Test Structure</h2>
      <ul>
        <li><strong>Task 1:</strong> 20 minutes, 150+ words (Table description)</li>
        <li><strong>Task 2:</strong> 40 minutes, 250+ words (Essay writing)</li>
      </ul>
      
      <h2>Test Duration</h2>
      <p>Total time: 60 minutes. Timer starts when you click "Start Test" and cannot be paused.</p>
      
      <div class="warning-box">
        <h2>⚠️ Test Security Rules</h2>
        <p><strong>Important:</strong> To maintain test integrity:</p>
        <ul>
          <li>Do not switch browser tabs or applications</li>
          <li>Do not use external resources or assistance</li>
          <li>Do not copy/paste content</li>
          <li>Type at a natural pace (monitored for fairness)</li>
          <li><strong>2 violations = automatic test submission</strong></li>
        </ul>
      </div>
      
      <h2>Technical Requirements</h2>
      <ul>
        <li>Stable internet connection required</li>
        <li>Do not refresh or use browser back button</li>
        <li>Responses auto-save in case of accidental closure</li>
      </ul>

      <div class="teacher-selection">
        <label style="display: block; font-weight: bold; color: #2c3e50; margin-bottom: 15px;">
          Select Your Teacher (Required):
        </label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Doniyor" required>
            <span>Mr Doniyor</span>
          </label>
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Xurshid" required>
            <span>Mr Xurshid</span>
          </label>
        </div>
      </div>

      <div class="name-input">
        <label style="display: block; font-weight: bold; color: #2c3e50; margin-bottom: 8px;">
          Enter Your Full Name (Required):
        </label>
        <input type="text" id="studentName" placeholder="Enter your full name as it should appear on the certificate" required>
        <small style="color: #7f8c8d; display: block; margin-top: 8px;">Your name will be included in the submission and PDF certificate.</small>
      </div>
      
      <p style="text-align: center; color: #7f8c8d; margin: 25px 0;">
        By clicking "Start Test", you acknowledge reading and agreeing to all test rules.
      </p>
      
      <button class="start-button" id="startButton" disabled>Start Test</button>
    </div>
  </div>

  <!-- Test Container -->
  <div id="testContainer">
    <div class="test-info">
      IELTS Writing Test - Set Four
    </div>
    
    <div class="header">
      <div class="student-name-display" id="studentNameDisplay"></div>
      <div class="top-right-info">
        <div class="timer-display" id="timer">60:00</div>
        <div class="violation-counter" id="violationCounter">Violations: 0/2</div>
      </div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/IELTS_logo.svg/2560px-IELTS_logo.svg.png" alt="IELTS Logo">
    </div>

    <div class="part-bar" id="partBar">
      Part 1 - You should spend about 20 minutes on this task. Write at least 150 words.
    </div>

    <!-- Task 1 Container -->
    <div class="main" id="mainContainer">
      <div class="left">
        <div class="task-content">
          <p><strong>The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.</strong></p>
          <p class="task-instructions">Summarise the information by selecting and reporting the main features, making comparisons where relevant.</p>
          <p class="task-instructions">Write at least 150 words.</p>
          <div class="image-container">
            <img src="https://i.ibb.co/ks6pw8LL/writing-table.jpg" alt="Physical Activities Table" onerror="this.src='https://via.placeholder.com/600x400/3498db/white?text=Table+Image+Loading+Failed'">
          </div>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea1" placeholder="Write your Task 1 response here...

• Describe the main trends
• Compare different activities
• Highlight significant changes
• Write at least 150 words" 
        spellcheck="false"></textarea>
        <div class="word-count" id="count1">Words: 0</div>
        <div class="typing-speed" id="speed1">Speed: 0 WPM</div>
      </div>
    </div>

    <!-- Task 2 Container -->
    <div class="main" id="mainContainer2" style="display: none;">
      <div class="left">
        <div class="task-content">
          <p><strong>Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging.</strong></p>
          <p class="task-instructions">Discuss both views and give your own opinion.</p>
          <p class="task-instructions">Write at least 250 words.</p>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea2" placeholder="Write your Task 2 response here...

• Discuss manufacturer/supermarket responsibility
• Discuss consumer responsibility  
• Give your own opinion with reasons
• Write at least 250 words"
        spellcheck="false"></textarea>
        <div class="word-count" id="count2">Words: 0</div>
        <div class="typing-speed" id="speed2">Speed: 0 WPM</div>
      </div>
    </div>

    <div class="loading" id="loadingIndicator">
      <div style="margin-bottom: 10px;">⏳ Sending answers to examiner...</div>
      <small>Please don't close this window</small>
    </div>
    
    <div class="submission-confirmation" id="submissionConfirmation">
      ✅ Test submitted successfully! PDF download should start automatically.
    </div>
    
    <button class="submit-btn" id="submitButton">Submit and Save as PDF</button>
    <button class="review-btn" id="reviewButton" style="display: none;">Review Answers</button>

    <div class="tab-buttons">
      <button id="tab1" class="active">Part 1 - Table Description</button>
      <button id="tab2">Part 2 - Essay Writing</button>
    </div>
  </div>

  <!-- Modals -->
  <div id="warningModal" class="modal">
    <div class="modal-content">
      <h2>⚠️ Test Violation Detected</h2>
      <p>You have switched to another application or tab during the test.</p>
      <p>This violates test rules. Your test will be automatically submitted.</p>
      <button id="forceSubmitBtn">OK</button>
    </div>
  </div>

  <div id="typingWarningModal" class="modal">
    <div class="modal-content">
      <h2>⚠️ Unusual Typing Pattern</h2>
      <p>Your typing speed appears unusually high, which may indicate pasting content.</p>
      <p>Please ensure you are typing your own responses.</p>
      <button id="closeTypingWarning">I Understand</button>
    </div>
  </div>

  <script>
    // Application State
    const state = {
      chosenTask1: { 
        question: "The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.\n\nSummarise the information by selecting and reporting the main features, making comparisons where relevant.\n\nWrite at least 150 words.", 
        image: "https://i.ibb.co/ks6pw8LL/writing-table.jpg" 
      },
      chosenTask2: "Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.",
      task1ImageData: "",
      totalSeconds: 60 * 60,
      isTestActive: false,
      warningCount: 0,
      maxWarnings: 2,
      timer: null,
      studentName: "",
      teacherName: "",
      isSubmitted: false,
      violationDetected: false,
      beforeUnloadTriggered: false,
      violations: {
        tabSwitching: 0,
        appSwitching: 0,
        highTypingSpeed: 0,
        pasteDetected: 0,
        rapidKeystrokes: 0,
        total: 0
      },
      typingData: {
        task1: { lastKeyTime: 0, lastWordCount: 0, keystrokes: 0, lastCalculationTime: 0, currentSpeed: 0, speedViolations: 0, pasteEvents: 0 },
        task2: { lastKeyTime: 0, lastWordCount: 0, keystrokes: 0, lastCalculationTime: 0, currentSpeed: 0, speedViolations: 0, pasteEvents: 0 }
      }
    };

    // Constants
    const SPEED_THRESHOLD = 120;
    const PASTE_THRESHOLD = 10;
    const RAPID_KEYSTROKE_THRESHOLD = 50;
    const MAX_SPEED_VIOLATIONS = 2;

    // DOM Elements
    const elements = {
      rulesScreen: document.getElementById('rulesScreen'),
      testContainer: document.getElementById('testContainer'),
      studentName: document.getElementById('studentName'),
      startButton: document.getElementById('startButton'),
      teacherRadios: document.querySelectorAll('input[name="teacher"]'),
      studentNameDisplay: document.getElementById('studentNameDisplay'),
      timer: document.getElementById('timer'),
      violationCounter: document.getElementById('violationCounter'),
      partBar: document.getElementById('partBar'),
      textarea1: document.getElementById('textarea1'),
      textarea2: document.getElementById('textarea2'),
      count1: document.getElementById('count1'),
      count2: document.getElementById('count2'),
      speed1: document.getElementById('speed1'),
      speed2: document.getElementById('speed2'),
      submitButton: document.getElementById('submitButton'),
      reviewButton: document.getElementById('reviewButton'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      submissionConfirmation: document.getElementById('submissionConfirmation'),
      tab1: document.getElementById('tab1'),
      tab2: document.getElementById('tab2'),
      mainContainer: document.getElementById('mainContainer'),
      mainContainer2: document.getElementById('mainContainer2'),
      warningModal: document.getElementById('warningModal'),
      typingWarningModal: document.getElementById('typingWarningModal'),
      forceSubmitBtn: document.getElementById('forceSubmitBtn'),
      closeTypingWarning: document.getElementById('closeTypingWarning')
    };

    // Initialize Application
    function initializeApp() {
      setupEventListeners();
      updateStartButtonState();
    }

    function setupEventListeners() {
      // Rules screen events
      elements.studentName.addEventListener('input', updateStartButtonState);
      elements.teacherRadios.forEach(radio => {
        radio.addEventListener('change', updateStartButtonState);
      });
      elements.startButton.addEventListener('click', startTest);
      elements.studentName.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !elements.startButton.disabled) startTest();
      });

      // Test control events
      elements.submitButton.addEventListener('click', submitTest);
      elements.reviewButton.addEventListener('click', reviewTest);
      elements.tab1.addEventListener('click', () => switchTab(1));
      elements.tab2.addEventListener('click', () => switchTab(2));
      elements.forceSubmitBtn.addEventListener('click', forceSubmit);
      elements.closeTypingWarning.addEventListener('click', closeTypingWarning);

      // Text area events
      elements.textarea1.addEventListener('input', () => updateWordCount('1'));
      elements.textarea2.addEventListener('input', () => updateWordCount('2'));
      elements.textarea1.addEventListener('keydown', () => handleTyping('1'));
      elements.textarea2.addEventListener('keydown', () => handleTyping('2'));
      elements.textarea1.addEventListener('paste', () => handlePaste('1'));
      elements.textarea2.addEventListener('paste', () => handlePaste('2'));
    }

    function updateStartButtonState() {
      const isTeacherSelected = Array.from(elements.teacherRadios).some(radio => radio.checked);
      const isNameValid = elements.studentName.value.trim().length >= 2;
      elements.startButton.disabled = !(isTeacherSelected && isNameValid);
    }

    function startTest() {
      const selectedTeacher = document.querySelector('input[name="teacher"]:checked');
      state.studentName = elements.studentName.value.trim();
      
      if (!selectedTeacher || state.studentName.length < 2) {
        alert("Please select your teacher and enter your full name.");
        return;
      }
      
      state.teacherName = selectedTeacher.value;
      
      // Switch to test view
      elements.rulesScreen.style.display = 'none';
      elements.testContainer.style.display = 'block';
      state.isTestActive = true;
      
      // Update UI
      elements.studentNameDisplay.innerHTML = `Teacher: ${state.teacherName}<br>Student: ${state.studentName}`;
      elements.violationCounter.style.display = 'block';
      updateViolationCounter();
      
      // Initialize test systems
      startTimer();
      activateAntiCheating();
      preloadImage();
      initializeTypingMonitoring();
      
      console.log('✅ Test started for:', state.studentName);
    }

    function updateViolationCounter() {
      elements.violationCounter.textContent = `Violations: ${state.warningCount}/${state.maxWarnings}`;
      if (state.warningCount > 0) {
        elements.violationCounter.classList.add('warning');
      }
    }

    function initializeTypingMonitoring() {
      setInterval(() => {
        calculateTypingSpeed('1');
        calculateTypingSpeed('2');
      }, 3000);
    }

    function handleTyping(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const now = Date.now();
      const data = state.typingData[`task${task}`];
      
      if (data.lastKeyTime > 0) {
        const timeDiff = now - data.lastKeyTime;
        if (timeDiff < RAPID_KEYSTROKE_THRESHOLD) {
          state.violations.rapidKeystrokes++;
        }
      }
      
      data.lastKeyTime = now;
      data.keystrokes++;
    }

    function handlePaste(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const data = state.typingData[`task${task}`];
      const textarea = elements[`textarea${task}`];
      const beforePasteWords = textarea.value.trim().split(/\s+/).length;
      
      setTimeout(() => {
        const afterPasteWords = textarea.value.trim().split(/\s+/).length;
        const wordIncrease = afterPasteWords - beforePasteWords;
        
        if (wordIncrease > PASTE_THRESHOLD) {
          data.pasteEvents++;
          state.violations.pasteDetected++;
          handleTypingViolation(task, `Pasted ${wordIncrease} words detected`);
        }
      }, 100);
    }

    function calculateTypingSpeed(task) {
      const data = state.typingData[`task${task}`];
      const now = Date.now();
      const textarea = elements[`textarea${task}`];
      const currentWordCount = textarea.value.trim().split(/\s+/).length;
      
      if (data.lastCalculationTime > 0) {
        const timeDiff = (now - data.lastCalculationTime) / 1000 / 60;
        const wordDiff = currentWordCount - data.lastWordCount;
        
        if (timeDiff > 0) {
          data.currentSpeed = Math.round(wordDiff / timeDiff);
          
          const speedElement = elements[`speed${task}`];
          speedElement.textContent = `Speed: ${data.currentSpeed} WPM`;
          
          if (data.currentSpeed > SPEED_THRESHOLD && wordDiff > 5) {
            speedElement.classList.add('warning');
            state.violations.highTypingSpeed++;
            handleTypingViolation(task, `High typing speed: ${data.currentSpeed} WPM`);
          } else {
            speedElement.classList.remove('warning');
          }
        }
      }
      
      data.lastCalculationTime = now;
      data.lastWordCount = currentWordCount;
      data.keystrokes = 0;
    }

    function handleTypingViolation(task, reason) {
      const data = state.typingData[`task${task}`];
      data.speedViolations++;
      
      if (data.speedViolations >= MAX_SPEED_VIOLATIONS) {
        handleViolation('typing', reason);
        data.speedViolations = 0;
      } else if (data.speedViolations === 1) {
        elements.typingWarningModal.style.display = 'flex';
      }
    }

    function closeTypingWarning() {
      elements.typingWarningModal.style.display = 'none';
    }

    function preloadImage() {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        state.task1ImageData = canvas.toDataURL('image/png');
      };
      img.onerror = function() {
        console.warn('Failed to load task image');
      };
      img.src = state.chosenTask1.image;
    }

    function startTimer() {
      elements.timer.textContent = '60:00';
      
      state.timer = setInterval(() => {
        const minutes = Math.floor(state.totalSeconds / 60);
        const seconds = state.totalSeconds % 60;
        elements.timer.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        
        // Warning state for last 5 minutes
        if (state.totalSeconds <= 300) {
          elements.timer.classList.add('warning');
        }
        
        // Time's up
        if (state.totalSeconds === 0) {
          clearInterval(state.timer);
          if (!state.isSubmitted) {
            alert("Time is up! Your work will be saved automatically.");
            submitTest();
          }
          state.isTestActive = false;
        }
        state.totalSeconds--;
      }, 1000);
    }

    function activateAntiCheating() {
      document.addEventListener("visibilitychange", function() {
        if (document.hidden && state.isTestActive && !state.violationDetected) {
          state.violations.tabSwitching++;
          handleViolation('tab_switch', 'Tab switching detected');
        }
      });

      window.addEventListener("blur", function() {
        if (state.isTestActive && !state.violationDetected) {
          state.violations.appSwitching++;
          handleViolation('app_switch', 'Application switching detected');
        }
      });

      document.addEventListener('contextmenu', function(e) {
        if (state.isTestActive) {
          e.preventDefault();
          return false;
        }
      });

      document.addEventListener('keydown', function(e) {
        if (state.isTestActive) {
          if (e.key === 'F12' || 
              (e.ctrlKey && e.shiftKey && e.key === 'I') ||
              (e.ctrlKey && e.shiftKey && e.key === 'C') ||
              (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
            return false;
          }
        }
      });
    }

    function handleViolation(type, reason) {
      state.violationDetected = true;
      state.violations.total++;
      state.warningCount++;
      
      updateViolationCounter();
      
      if (state.warningCount >= state.maxWarnings) {
        elements.warningModal.style.display = 'flex';
      } else {
        alert(`Warning ${state.warningCount}/${state.maxWarnings}: ${getViolationMessage(type)}`);
        setTimeout(() => { state.violationDetected = false; }, 1000);
      }
    }

    function getViolationMessage(type) {
      const messages = {
        'tab_switch': 'Switching browser tabs is not allowed during the test.',
        'app_switch': 'Switching to other applications is not allowed during the test.',
        'typing': 'Unusual typing pattern detected. Please ensure you are typing your own responses.',
        'default': 'Test rule violation detected.'
      };
      return messages[type] || messages.default;
    }

    function updateWordCount(part) {
      const textarea = elements[`textarea${part}`];
      const countElement = elements[`count${part}`];
      const text = textarea.value.trim();
      const wordCount = text === "" ? 0 : text.split(/\s+/).length;
      
      countElement.textContent = `Words: ${wordCount}`;
      
      const minWords = part === "1" ? 150 : 250;
      if (wordCount < minWords) {
        countElement.classList.add("warning");
      } else {
        countElement.classList.remove("warning");
      }
    }

    function switchTab(part) {
      elements.mainContainer.style.display = part === 1 ? 'flex' : 'none';
      elements.mainContainer2.style.display = part === 2 ? 'flex' : 'none';

      elements.tab1.classList.toggle('active', part === 1);
      elements.tab2.classList.toggle('active', part === 2);

      const partText = part === 1
        ? "Part 1 - You should spend about 20 minutes on this task. Write at least 150 words."
        : "Part 2 - You should spend about 40 minutes on this task. Write at least 250 words.";

      elements.partBar.textContent = partText;
    }

    async function sendToTelegram(message, testData) {
      try {
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/telegram`;
        
        console.log('📨 Sending to Telegram API:', apiUrl);

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            studentName: testData.studentName,
            teacherName: testData.teacherName,
            violations: testData.violations,
            task1WordCount: testData.task1WordCount,
            task2WordCount: testData.task2WordCount,
            totalWords: testData.totalWords,
            testDuration: testData.testDuration
          })
        });
        
        const result = await response.json();
        console.log('📨 Telegram API response:', result);
        
        return result.success;
        
      } catch (error) {
        console.error('❌ Network error sending to Telegram:', error);
        return false;
      }
    }

    async function submitTest() {
      if (state.isSubmitted) {
        alert("Test has already been submitted. You can only review your answers.");
        return;
      }
      
      // Show loading state
      elements.loadingIndicator.style.display = 'block';
      elements.submitButton.disabled = true;
      
      // Collect answers and statistics
      const task1Answer = elements.textarea1.value;
      const task2Answer = elements.textarea2.value;
      const task1WordCount = task1Answer.trim() === "" ? 0 : task1Answer.trim().split(/\s+/).length;
      const task2WordCount = task2Answer.trim() === "" ? 0 : task2Answer.trim().split(/\s+/).length;
      const totalWords = task1WordCount + task2WordCount;
      const testDuration = 60 * 60 - state.totalSeconds;
      
      // Format Telegram message
      const telegramMessage = `📝 IELTS WRITING TEST SUBMITTED

👤 STUDENT INFORMATION
• Name: ${state.studentName}
• Teacher: ${state.teacherName}
• Test: IELTS Writing Test - Set Four
• Timestamp: ${new Date().toLocaleString()}
• Duration: ${testDuration} seconds

📋 TASK 1 - TABLE DESCRIPTION
Question:
The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.

Summarise the information by selecting and reporting the main features, making comparisons where relevant.

Write at least 150 words.

📝 Student's Answer:
${task1Answer || 'No answer provided'}

📊 Task 1 Statistics:
• Words: ${task1WordCount}
• Actual Word Count: ${task1WordCount}

📝 TASK 2 - ESSAY WRITING
Question:
Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.

📝 Student's Answer:
${task2Answer || 'No answer provided'}

📊 Task 2 Statistics:
• Words: ${task2WordCount}
• Actual Word Count: ${task2WordCount}

📈 OVERALL STATISTICS
• Total Words Written: ${totalWords}
• Task 1 Words: ${task1WordCount} ${task1WordCount < 150 ? "❌" : "✅"}
• Task 2 Words: ${task2WordCount} ${task2WordCount < 250 ? "❌" : "✅"}

🚨 VIOLATION REPORT
• Total Violations: ${state.violations.total}
• Tab Switching: ${state.violations.tabSwitching}
• App Switching: ${state.violations.appSwitching}
• High Typing Speed: ${state.violations.highTypingSpeed}
• Paste Detected: ${state.violations.pasteDetected}
• Rapid Keystrokes: ${state.violations.rapidKeystrokes}
• Final Warnings: ${state.warningCount}/${state.maxWarnings}

---
✅ Test automatically submitted and recorded
🕒 System Time: ${new Date().toLocaleString()}`;

      const testData = {
        studentName: state.studentName,
        teacherName: state.teacherName,
        violations: { ...state.violations, warningCount: state.warningCount },
        task1WordCount,
        task2WordCount,
        totalWords,
        testDuration
      };

      // Send to Telegram
      const telegramSuccess = await sendToTelegram(telegramMessage, testData);
      
      // Generate PDF
      downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount);
      
      // Update UI
      elements.loadingIndicator.style.display = 'none';
      state.isTestActive = false;
      state.isSubmitted = true;
      clearInterval(state.timer);
      
      elements.submitButton.style.display = 'none';
      elements.reviewButton.style.display = 'block';
      elements.submissionConfirmation.style.display = 'block';
      
      elements.textarea1.disabled = true;
      elements.textarea2.disabled = true;
      
      if (!telegramSuccess) {
        console.warn('Telegram notification failed. Check environment variables.');
      }
      
      console.log('✅ Test submitted successfully');
    }

    function reviewTest() {
      alert("You are now in review mode. You can read your answers but cannot make changes.");
    }

    function downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      doc.setFontSize(18);
      doc.setTextColor(41, 128, 185);
      doc.text("IELTS Writing Test - Set Four", 20, 20);
      
      doc.setFontSize(11);
      doc.setTextColor(100, 100, 100);
      doc.text(`Teacher: ${state.teacherName}`, 20, 30);
      doc.text(`Student: ${state.studentName}`, 20, 36);
      doc.text(`Submitted: ${new Date().toLocaleString()}`, 20, 42);
      doc.text(`Violations: ${state.violations.total} (${state.warningCount}/2 warnings)`, 20, 48);

      // Task 1
      doc.setFontSize(14);
      doc.setTextColor(0, 0, 0);
      doc.text("TASK 1 - TABLE DESCRIPTION", 20, 60);
      
      doc.setFontSize(10);
      const task1Question = "The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009. Summarise the information by selecting and reporting the main features, making comparisons where relevant.";
      const task1Lines = doc.splitTextToSize(task1Question, 170);
      doc.text(task1Lines, 20, 70);
      
      doc.text("Student's Answer:", 20, 90);
      const answer1Lines = doc.splitTextToSize(task1Answer || "No answer provided", 170);
      doc.text(answer1Lines, 20, 100);
      
      doc.text(`Word Count: ${task1WordCount} ${task1WordCount < 150 ? "(Below minimum)" : "(Meets requirement)"}`, 20, 130);

      // Task 2 (new page)
      doc.addPage();
      doc.setFontSize(18);
      doc.setTextColor(41, 128, 185);
      doc.text("IELTS Writing Test - Set Four", 20, 20);
      
      doc.setFontSize(14);
      doc.text("TASK 2 - ESSAY WRITING", 20, 40);
      
      doc.setFontSize(10);
      const task2Question = "Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.";
      const task2Lines = doc.splitTextToSize(task2Question, 170);
      doc.text(task2Lines, 20, 50);
      
      doc.text("Student's Answer:", 20, 80);
      const answer2Lines = doc.splitTextToSize(task2Answer || "No answer provided", 170);
      doc.text(answer2Lines, 20, 90);
      
      doc.text(`Word Count: ${task2WordCount} ${task2WordCount < 250 ? "(Below minimum)" : "(Meets requirement)"}`, 20, 260);

      // Save PDF
      const fileName = `IELTS_Writing_${state.studentName.replace(/\s+/g, '_')}_${Date.now()}.pdf`;
      doc.save(fileName);
    }

    function forceSubmit() {
      state.isTestActive = false;
      state.violationDetected = false;
      elements.warningModal.style.display = 'none';
      submitTest();
      clearInterval(state.timer);
    }

    // Page lifecycle management
    window.onbeforeunload = function (e) {
      if (state.isTestActive && !state.isSubmitted && !state.beforeUnloadTriggered) {
        const message = "Are you sure you want to leave? Your test progress may be lost.";
        e.returnValue = message;
        return message;
      }
    };

    window.addEventListener('unload', function() {
      if (state.isTestActive && !state.isSubmitted && !state.beforeUnloadTriggered) {
        state.beforeUnloadTriggered = true;
        submitTest();
      }
    });

    // Initialize the application
    window.addEventListener('load', initializeApp);
  </script>
</body>
</html>
