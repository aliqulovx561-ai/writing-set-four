<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IELTS Writing Test - Set Four</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #fff;
    }
    .header {
      background-color: white;
      padding: 15px 30px;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }
    .header img {
      height: 30px;
    }
    .top-right-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 5px;
    }
    .timer-display {
      font-weight: bold;
      font-size: 18px;
      color: #d32f2f;
      background-color: #f8f9fa;
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid #d32f2f;
    }
    .violation-counter {
      background-color: #fff3cd;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .part-bar {
      background-color: #f2f4ec;
      padding: 15px 30px;
      font-size: 16px;
      border-bottom: 1px solid #ccc;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      border-top: 1px solid #ccc;
      background: #f9f9f9;
    }
    .tab-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      background: #eee;
    }
    .tab-buttons button.active {
      background: #d0d0d0;
    }
    .main {
      display: flex;
      height: calc(100vh - 240px);
      overflow: hidden;
    }
    .left, .right {
      padding: 20px 30px;
      overflow-y: auto;
    }
    .left {
      width: 50%;
      border-right: 4px solid #999;
      resize: horizontal;
      overflow: auto;
      min-width: 250px;
    }
    .right {
      width: 50%;
      resize: horizontal;
      min-width: 250px;
    }
    .image-container img {
      width: 100%;
      height: auto;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    textarea {
      width: 100%;
      height: 100%;
      font-size: 16px;
      padding: 10px;
      resize: none;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .word-count {
      text-align: right;
      font-size: 14px;
      margin-top: 5px;
    }
    .word-count.warning {
      color: #d32f2f;
    }
    .submit-btn {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px auto;
      font-size: 16px;
      cursor: pointer;
      display: block;
      border-radius: 4px;
    }
    .submit-btn:hover {
      background-color: #106ebe;
    }
    .submit-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .review-btn {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      margin: 10px auto;
      font-size: 16px;
      cursor: pointer;
      display: block;
      border-radius: 4px;
    }
    .review-btn:hover {
      background-color: #5a6268;
    }
    
    .test-info {
      background-color: #e9f7fe;
      padding: 10px 30px;
      border-bottom: 1px solid #b8daff;
      font-size: 14px;
      color: #004085;
    }
    
    #rulesScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: white;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .rules-container {
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      background-color: #f9f9f9;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .rules-container h1 {
      color: #0078d7;
      text-align: center;
      margin-bottom: 20px;
    }
    .rules-container h2 {
      color: #333;
      margin-top: 25px;
      margin-bottom: 10px;
    }
    .rules-container p, .rules-container ul {
      margin-bottom: 15px;
      line-height: 1.6;
    }
    .rules-container ul {
      padding-left: 20px;
    }
    .rules-container li {
      margin-bottom: 8px;
    }
    .rules-container .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    .rules-container .warning strong {
      color: #856404;
    }
    
    .teacher-selection {
      margin: 20px 0;
      padding: 15px;
      background-color: #e9f7fe;
      border-radius: 8px;
      border: 2px solid #0078d7;
    }
    .teacher-selection label {
      display: block;
      margin-bottom: 12px;
      font-weight: bold;
      color: #0078d7;
    }
    .radio-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .radio-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-weight: normal;
      color: #333;
      position: relative;
      padding-left: 30px;
    }
    .radio-label input[type="radio"] {
      position: absolute;
      opacity: 0;
      cursor: pointer;
    }
    .radio-custom {
      position: absolute;
      top: 0;
      left: 0;
      height: 20px;
      width: 20px;
      background-color: #fff;
      border-radius: 50%;
      border: 2px solid #0078d7;
      transition: all 0.3s ease;
    }
    .radio-label input[type="radio"]:checked ~ .radio-custom {
      background-color: #0078d7;
      border-color: #0078d7;
    }
    .radio-custom:after {
      content: "";
      position: absolute;
      display: none;
      top: 4px;
      left: 4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }
    .radio-label input[type="radio"]:checked ~ .radio-custom:after {
      display: block;
    }
    .radio-label:hover .radio-custom {
      border-color: #005a9e;
      transform: scale(1.1);
    }
    
    .name-input {
      margin: 20px 0;
      padding: 15px;
      background-color: #e9f7fe;
      border-radius: 8px;
      border: 2px solid #0078d7;
    }
    .name-input label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #0078d7;
    }
    .name-input input {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .name-input input:focus {
      outline: none;
      border-color: #0078d7;
      box-shadow: 0 0 5px rgba(0,120,215,0.3);
    }
    .start-button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 20px;
      font-weight: bold;
    }
    .start-button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    .start-button:hover:not(:disabled) {
      background-color: #218838;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal h2 {
      color: #d32f2f;
      margin-top: 0;
    }
    .modal p {
      margin: 20px 0;
      line-height: 1.5;
    }
    .modal button {
      background-color: #d32f2f;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    #testContainer {
      display: none;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 10px;
      color: #0078d7;
    }
    
    .task-content {
      margin-top: 15px;
    }
    .task-content p {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .task-content .task-instructions {
      color: #666;
      font-style: italic;
      margin-top: 10px;
    }
    
    .submission-confirmation {
      text-align: center;
      padding: 10px;
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 4px;
      margin: 10px 30px;
    }
    
    .typing-speed {
      text-align: right;
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .typing-speed.warning {
      color: #d32f2f;
      font-weight: bold;
    }
    
    .student-name-display {
      font-weight: bold;
      line-height: 1.4;
    }
  </style>
</head>
<body>

  <div id="rulesScreen">
    <div class="rules-container">
      <h1>IELTS Writing Test - Set Four</h1>
      <h2>Test Rules and Instructions</h2>
      <p>Please read the following rules carefully before starting your IELTS Writing Test.</p>
      
      <h2>Test Structure</h2>
      <p>The IELTS Writing Test consists of two tasks:</p>
      <ul>
        <li><strong>Task 1:</strong> You should spend about 20 minutes on this task. Write at least 150 words.</li>
        <li><strong>Task 2:</strong> You should spend about 40 minutes on this task. Write at least 250 words.</li>
      </ul>
      
      <h2>Test Duration</h2>
      <p>The total time for the Writing Test is 60 minutes. The timer will start when you click "I Understand" and cannot be paused.</p>
      
      <h2>Important Rules</h2>
      <ul>
        <li>You must complete both writing tasks within the 60-minute time limit.</li>
        <li>You must write your answers in the provided text areas.</li>
        <li>You can switch between Task 1 and Task 2 using the tabs at the bottom of the screen.</li>
        <li>Your work will be automatically saved as a PDF when you click "Submit and Save as PDF" or when time expires.</li>
        <li>Your answers will be sent to the examiner via Telegram for evaluation.</li>
      </ul>
      
      <div class="warning">
        <h2>⚠️ Test Security Rules</h2>
        <p><strong>Important:</strong> To maintain test integrity, the following restrictions apply:</p>
        <ul>
          <li>You <strong>must not</strong> switch to other browser tabs, applications, or windows during the test.</li>
          <li>You <strong>must not</strong> use any external resources, dictionaries, or assistance.</li>
          <li>You <strong>must not</strong> copy, paste, or use keyboard shortcuts to open new tabs or windows.</li>
          <li>You <strong>must not</strong> type at unrealistically high speeds or paste pre-written content.</li>
          <li>If you attempt to leave the test window or type too fast, you will receive a warning.</li>
          <li><strong>Two violations will result in automatic test termination and submission.</strong></li>
        </ul>
      </div>
      
      <h2>Technical Requirements</h2>
      <ul>
        <li>Ensure you have a stable internet connection throughout the test.</li>
        <li>Do not refresh the page or use the browser's back button during the test.</li>
        <li>Your responses will be saved automatically in case of accidental page closure.</li>
      </ul>

      <div class="teacher-selection">
        <label>Select Your Teacher (Required):</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Doniyor" required>
            <span class="radio-custom"></span>
            Mr Doniyor
          </label>
          <label class="radio-label">
            <input type="radio" name="teacher" value="Mr Xurshid" required>
            <span class="radio-custom"></span>
            Mr Xurshid
          </label>
        </div>
      </div>

      <div class="name-input">
        <label for="studentName">Enter Your Full Name (Required):</label>
        <input type="text" id="studentName" placeholder="Please enter your full name" required>
        <small style="color: #666; display: block; margin-top: 5px;">Your name will be included in the test submission and PDF.</small>
      </div>
      
      <p>By clicking "I Understand" below, you acknowledge that you have read and agree to these rules, and you are ready to begin your IELTS Writing Test.</p>
      
      <button class="start-button" id="startButton" disabled>I Understand - Start Test</button>
    </div>
  </div>

  <div id="testContainer">
    <div class="test-info">
      <strong>IELTS Writing Test - Set Four</strong>
    </div>
    
    <div class="header">
      <div class="student-name-display" id="studentNameDisplay"></div>
      <div class="top-right-info">
        <div class="timer-display" id="timer">60:00</div>
        <div class="violation-counter" id="violationCounter" style="display: none;">Violations: 0/2</div>
      </div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e4/IELTS_logo.svg/2560px-IELTS_logo.svg.png" alt="IELTS">
    </div>

    <div id="partBar" class="part-bar">
      Part 1<br>
      You should spend about 20 minutes on this task. Write at least 150 words.
    </div>

    <div class="main" id="mainContainer">
      <div class="left" id="left1">
        <div class="task-content">
          <p><strong>The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.</strong></p>
          <p class="task-instructions">Summarise the information by selecting and reporting the main features, making comparisons where relevant.</p>
          <p class="task-instructions">Write at least 150 words.</p>
          <div class="image-container">
            <img src="https://i.ibb.co/ks6pw8LL/writing-table.jpg" alt="Physical Activities Table">
          </div>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea1" spellcheck="false" placeholder="Write your Task 1 response here..." oninput="updateWordCount('1')" onkeydown="handleTyping('1')" onpaste="handlePaste('1')"></textarea>
        <div class="word-count" id="count1">Words: 0</div>
        <div class="typing-speed" id="speed1">Speed: 0 WPM</div>
      </div>
    </div>

    <div class="main" id="mainContainer2" style="display: none;">
      <div class="left" id="left2">
        <div class="task-content">
          <p><strong>Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.</strong></p>
          <p class="task-instructions">Discuss both views and give your opinion.</p>
          <p class="task-instructions">Write at least 250 words.</p>
        </div>
      </div>
      <div class="right">
        <textarea id="textarea2" spellcheck="false" placeholder="Write your Task 2 response here..." oninput="updateWordCount('2')" onkeydown="handleTyping('2')" onpaste="handlePaste('2')"></textarea>
        <div class="word-count" id="count2">Words: 0</div>
        <div class="typing-speed" id="speed2">Speed: 0 WPM</div>
      </div>
    </div>

    <div class="loading" id="loadingIndicator">Sending answers to examiner... Please wait.</div>
    
    <div id="submissionConfirmation" class="submission-confirmation" style="display: none;">
      Test submitted successfully! You can now review your answers.
    </div>
    
    <button class="submit-btn" id="submitButton">Submit and Save as PDF</button>
    <button class="review-btn" id="reviewButton" style="display: none;">Review Only</button>

    <div class="tab-buttons">
      <button id="tab1" class="active">Part 1</button>
      <button id="tab2">Part 2</button>
    </div>
  </div>

  <div id="warningModal" class="modal">
    <div class="modal-content">
      <h2>Warning: Test Violation</h2>
      <p>You have switched to another application or tab during the test.</p>
      <p>This is a violation of test rules. Your test will be automatically submitted now.</p>
      <button id="forceSubmitBtn">OK</button>
    </div>
  </div>

  <div id="typingWarningModal" class="modal">
    <div class="modal-content">
      <h2>Warning: Unusual Typing Pattern Detected</h2>
      <p>Your typing speed appears to be unusually high, which may indicate pasting content or using assistance.</p>
      <p>Please ensure you are typing your own responses. Further violations will result in test termination.</p>
      <button id="closeTypingWarning">I Understand</button>
    </div>
  </div>

  <script>
    // Application State
    const state = {
      chosenTask1: { 
        question: "The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.\n\nSummarise the information by selecting and reporting the main features, making comparisons where relevant.\n\nWrite at least 150 words.", 
        image: "https://i.ibb.co/ks6pw8LL/writing-table.jpg" 
      },
      chosenTask2: "Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.",
      task1ImageData: "",
      totalSeconds: 60 * 60,
      isTestActive: false,
      warningCount: 0,
      maxWarnings: 2,
      timer: null,
      studentName: "",
      teacherName: "",
      isSubmitted: false,
      violationDetected: false,
      beforeUnloadTriggered: false,
      violations: {
        tabSwitching: 0,
        appSwitching: 0,
        highTypingSpeed: 0,
        pasteDetected: 0,
        rapidKeystrokes: 0,
        total: 0
      },
      typingData: {
        task1: { lastKeyTime: 0, lastWordCount: 0, keystrokes: 0, lastCalculationTime: 0, currentSpeed: 0, speedViolations: 0, pasteEvents: 0 },
        task2: { lastKeyTime: 0, lastWordCount: 0, keystrokes: 0, lastCalculationTime: 0, currentSpeed: 0, speedViolations: 0, pasteEvents: 0 }
      }
    };

    // Constants
    const SPEED_THRESHOLD = 120;
    const PASTE_THRESHOLD = 10;
    const RAPID_KEYSTROKE_THRESHOLD = 50;
    const MAX_SPEED_VIOLATIONS = 2;

    // DOM Elements
    const elements = {
      rulesScreen: document.getElementById('rulesScreen'),
      testContainer: document.getElementById('testContainer'),
      studentName: document.getElementById('studentName'),
      startButton: document.getElementById('startButton'),
      teacherRadios: document.querySelectorAll('input[name="teacher"]'),
      studentNameDisplay: document.getElementById('studentNameDisplay'),
      timer: document.getElementById('timer'),
      violationCounter: document.getElementById('violationCounter'),
      partBar: document.getElementById('partBar'),
      textarea1: document.getElementById('textarea1'),
      textarea2: document.getElementById('textarea2'),
      count1: document.getElementById('count1'),
      count2: document.getElementById('count2'),
      speed1: document.getElementById('speed1'),
      speed2: document.getElementById('speed2'),
      submitButton: document.getElementById('submitButton'),
      reviewButton: document.getElementById('reviewButton'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      submissionConfirmation: document.getElementById('submissionConfirmation'),
      tab1: document.getElementById('tab1'),
      tab2: document.getElementById('tab2'),
      mainContainer: document.getElementById('mainContainer'),
      mainContainer2: document.getElementById('mainContainer2'),
      warningModal: document.getElementById('warningModal'),
      typingWarningModal: document.getElementById('typingWarningModal'),
      forceSubmitBtn: document.getElementById('forceSubmitBtn'),
      closeTypingWarning: document.getElementById('closeTypingWarning')
    };

    // Initialize Application
    function initializeApp() {
      setupEventListeners();
      updateStartButtonState();
    }

    function setupEventListeners() {
      // Rules screen events
      elements.studentName.addEventListener('input', updateStartButtonState);
      elements.teacherRadios.forEach(radio => {
        radio.addEventListener('change', updateStartButtonState);
      });
      elements.startButton.addEventListener('click', startTest);
      elements.studentName.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !elements.startButton.disabled) startTest();
      });

      // Test control events
      elements.submitButton.addEventListener('click', submitTest);
      elements.reviewButton.addEventListener('click', reviewTest);
      elements.tab1.addEventListener('click', () => switchTab(1));
      elements.tab2.addEventListener('click', () => switchTab(2));
      elements.forceSubmitBtn.addEventListener('click', forceSubmit);
      elements.closeTypingWarning.addEventListener('click', closeTypingWarning);

      // Text area events
      elements.textarea1.addEventListener('input', () => updateWordCount('1'));
      elements.textarea2.addEventListener('input', () => updateWordCount('2'));
      elements.textarea1.addEventListener('keydown', () => handleTyping('1'));
      elements.textarea2.addEventListener('keydown', () => handleTyping('2'));
      elements.textarea1.addEventListener('paste', () => handlePaste('1'));
      elements.textarea2.addEventListener('paste', () => handlePaste('2'));
    }

    function updateStartButtonState() {
      const isTeacherSelected = Array.from(elements.teacherRadios).some(radio => radio.checked);
      const isNameValid = elements.studentName.value.trim().length >= 2;
      elements.startButton.disabled = !(isTeacherSelected && isNameValid);
    }

    function startTest() {
      const selectedTeacher = document.querySelector('input[name="teacher"]:checked');
      state.studentName = elements.studentName.value.trim();
      
      if (!selectedTeacher || state.studentName.length < 2) {
        alert("Please select your teacher and enter your full name.");
        return;
      }
      
      state.teacherName = selectedTeacher.value;
      
      // Switch to test view
      elements.rulesScreen.style.display = 'none';
      elements.testContainer.style.display = 'block';
      state.isTestActive = true;
      
      // Update UI
      elements.studentNameDisplay.innerHTML = `Teacher: ${state.teacherName}<br>Student: ${state.studentName}`;
      elements.violationCounter.style.display = 'block';
      updateViolationCounter();
      
      // Initialize test systems
      startTimer();
      activateAntiCheating();
      preloadImage();
      initializeTypingMonitoring();
    }

    function updateViolationCounter() {
      elements.violationCounter.textContent = `Violations: ${state.warningCount}/${state.maxWarnings}`;
      if (state.warningCount > 0) {
        elements.violationCounter.style.backgroundColor = "#f8d7da";
        elements.violationCounter.style.color = "#721c24";
        elements.violationCounter.style.borderColor = "#f5c6cb";
      }
    }

    function initializeTypingMonitoring() {
      setInterval(() => {
        calculateTypingSpeed('1');
        calculateTypingSpeed('2');
      }, 3000);
    }

    function handleTyping(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const now = Date.now();
      const data = state.typingData[`task${task}`];
      
      if (data.lastKeyTime > 0) {
        const timeDiff = now - data.lastKeyTime;
        if (timeDiff < RAPID_KEYSTROKE_THRESHOLD) {
          state.violations.rapidKeystrokes++;
        }
      }
      
      data.lastKeyTime = now;
      data.keystrokes++;
    }

    function handlePaste(task) {
      if (!state.isTestActive || state.isSubmitted) return;
      
      const data = state.typingData[`task${task}`];
      const textarea = elements[`textarea${task}`];
      const beforePasteWords = textarea.value.trim().split(/\s+/).length;
      
      setTimeout(() => {
        const afterPasteWords = textarea.value.trim().split(/\s+/).length;
        const wordIncrease = afterPasteWords - beforePasteWords;
        
        if (wordIncrease > PASTE_THRESHOLD) {
          data.pasteEvents++;
          state.violations.pasteDetected++;
          handleTypingViolation(task, `Pasted ${wordIncrease} words detected`);
        }
      }, 100);
    }

    function calculateTypingSpeed(task) {
      const data = state.typingData[`task${task}`];
      const now = Date.now();
      const textarea = elements[`textarea${task}`];
      const currentWordCount = textarea.value.trim().split(/\s+/).length;
      
      if (data.lastCalculationTime > 0) {
        const timeDiff = (now - data.lastCalculationTime) / 1000 / 60;
        const wordDiff = currentWordCount - data.lastWordCount;
        
        if (timeDiff > 0) {
          data.currentSpeed = Math.round(wordDiff / timeDiff);
          
          const speedElement = elements[`speed${task}`];
          speedElement.textContent = `Speed: ${data.currentSpeed} WPM`;
          
          if (data.currentSpeed > SPEED_THRESHOLD && wordDiff > 5) {
            speedElement.classList.add('warning');
            state.violations.highTypingSpeed++;
            handleTypingViolation(task, `High typing speed: ${data.currentSpeed} WPM`);
          } else {
            speedElement.classList.remove('warning');
          }
        }
      }
      
      data.lastCalculationTime = now;
      data.lastWordCount = currentWordCount;
      data.keystrokes = 0;
    }

    function handleTypingViolation(task, reason) {
      const data = state.typingData[`task${task}`];
      data.speedViolations++;
      
      if (data.speedViolations >= MAX_SPEED_VIOLATIONS) {
        handleViolation('typing', reason);
        data.speedViolations = 0;
      } else if (data.speedViolations === 1) {
        elements.typingWarningModal.style.display = 'flex';
      }
    }

    function closeTypingWarning() {
      elements.typingWarningModal.style.display = 'none';
    }

    function preloadImage() {
      const img = new Image();
      img.crossOrigin = "Anonymous";
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        state.task1ImageData = canvas.toDataURL('image/png');
      };
      img.src = state.chosenTask1.image;
    }

    function startTimer() {
      elements.timer.textContent = '60:00';
      
      state.timer = setInterval(() => {
        const minutes = Math.floor(state.totalSeconds / 60);
        const seconds = state.totalSeconds % 60;
        elements.timer.textContent = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
        
        if (state.totalSeconds <= 300) {
          elements.timer.style.color = "#d32f2f";
          elements.timer.style.fontSize = "20px";
        }
        
        if (state.totalSeconds === 0) {
          clearInterval(state.timer);
          if (!state.isSubmitted) {
            alert("Time is up! Your work will be saved automatically.");
            submitTest();
          }
          state.isTestActive = false;
        }
        state.totalSeconds--;
      }, 1000);
    }

    function activateAntiCheating() {
      document.addEventListener("visibilitychange", function() {
        if (document.hidden && state.isTestActive && !state.violationDetected) {
          state.violations.tabSwitching++;
          handleViolation('tab_switch', 'Tab switching detected');
        }
      });

      window.addEventListener("blur", function() {
        if (state.isTestActive && !state.violationDetected) {
          state.violations.appSwitching++;
          handleViolation('app_switch', 'Application switching detected');
        }
      });

      document.addEventListener('contextmenu', function(e) {
        if (state.isTestActive) {
          e.preventDefault();
          return false;
        }
      });

      document.addEventListener('keydown', function(e) {
        if (state.isTestActive) {
          if (e.key === 'F12' || 
              (e.ctrlKey && e.shiftKey && e.key === 'I') ||
              (e.ctrlKey && e.shiftKey && e.key === 'C')) {
            e.preventDefault();
            return false;
          }
        }
      });
    }

    function handleViolation(type, reason) {
      state.violationDetected = true;
      state.violations.total++;
      state.warningCount++;
      
      updateViolationCounter();
      
      if (state.warningCount >= state.maxWarnings) {
        elements.warningModal.style.display = 'flex';
      } else {
        alert(`Warning ${state.warningCount}/${state.maxWarnings}: ${getViolationMessage(type)} \n\nNext violation will result in automatic test termination.`);
        setTimeout(() => { state.violationDetected = false; }, 1000);
      }
    }

    function getViolationMessage(type) {
      const messages = {
        'tab_switch': 'Switching browser tabs is not allowed during the test.',
        'app_switch': 'Switching to other applications is not allowed during the test.',
        'typing': 'Unusual typing pattern detected. Please ensure you are typing your own responses.',
        'default': 'Test rule violation detected.'
      };
      return messages[type] || messages.default;
    }

    function updateWordCount(part) {
      const textarea = elements[`textarea${part}`];
      const countElement = elements[`count${part}`];
      const text = textarea.value.trim();
      const wordCount = text === "" ? 0 : text.split(/\s+/).length;
      
      countElement.textContent = `Words: ${wordCount}`;
      
      const minWords = part === "1" ? 150 : 250;
      if (wordCount < minWords) {
        countElement.classList.add("warning");
      } else {
        countElement.classList.remove("warning");
      }
    }

    function switchTab(part) {
      elements.mainContainer.style.display = part === 1 ? 'flex' : 'none';
      elements.mainContainer2.style.display = part === 2 ? 'flex' : 'none';

      elements.tab1.classList.remove("active");
      elements.tab2.classList.remove("active");
      elements[`tab${part}`].classList.add("active");

      const partText = part === 1
        ? "Part 1<br>You should spend about 20 minutes on this task. Write at least 150 words."
        : "Part 2<br>You should spend about 40 minutes on this task. Write at least 250 words.";

      elements.partBar.innerHTML = partText;
    }

    async function sendToTelegram(message, testData) {
      try {
        const baseUrl = window.location.origin;
        const apiUrl = `${baseUrl}/api/telegram`;
        
        console.log('📨 Sending to Telegram API:', apiUrl);

        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: message,
            studentName: testData.studentName,
            teacherName: testData.teacherName,
            violations: testData.violations,
            task1WordCount: testData.task1WordCount,
            task2WordCount: testData.task2WordCount,
            totalWords: testData.totalWords,
            testDuration: testData.testDuration
          })
        });
        
        const result = await response.json();
        console.log('📨 Telegram API response:', result);
        
        return result.success;
        
      } catch (error) {
        console.error('❌ Network error sending to Telegram:', error);
        return false;
      }
    }

    async function submitTest() {
      if (state.isSubmitted) {
        alert("Test has already been submitted. You can only review your answers now.");
        return;
      }
      
      // Show loading state
      elements.loadingIndicator.style.display = 'block';
      elements.submitButton.disabled = true;
      
      // Collect answers and statistics
      const task1Answer = elements.textarea1.value;
      const task2Answer = elements.textarea2.value;
      const task1WordCount = task1Answer.trim() === "" ? 0 : task1Answer.trim().split(/\s+/).length;
      const task2WordCount = task2Answer.trim() === "" ? 0 : task2Answer.trim().split(/\s+/).length;
      const totalWords = task1WordCount + task2WordCount;
      const testDuration = 60 * 60 - state.totalSeconds;
      
      // Format Telegram message
      const telegramMessage = `📝 IELTS WRITING TEST SUBMITTED

👤 STUDENT INFORMATION
• Name: ${state.studentName}
• Teacher: ${state.teacherName}
• Test: IELTS Writing Test - Set Four
• Timestamp: ${new Date().toLocaleString()}
• Duration: ${testDuration} seconds

📋 TASK 1 - TABLE DESCRIPTION
Question:
The table below shows the change in the number of people (million) taking part in five different physical activities between 2001 and 2009.

Summarise the information by selecting and reporting the main features, making comparisons where relevant.

Write at least 150 words.

📝 Student's Answer:
${task1Answer || 'No answer provided'}

📊 Task 1 Statistics:
• Words: ${task1WordCount}
• Actual Word Count: ${task1WordCount}

📝 TASK 2 - ESSAY WRITING
Question:
Some people say manufacturers and supermarkets are responsible for reducing the packaging on the products they sell. Others argue that consumers should buy products with less packaging. Discuss both views and give your own opinion.

📝 Student's Answer:
${task2Answer || 'No answer provided'}

📊 Task 2 Statistics:
• Words: ${task2WordCount}
• Actual Word Count: ${task2WordCount}

📈 OVERALL STATISTICS
• Total Words Written: ${totalWords}
• Task 1 Words: ${task1WordCount} ${task1WordCount < 150 ? "❌" : "✅"}
• Task 2 Words: ${task2WordCount} ${task2WordCount < 250 ? "❌" : "✅"}

🚨 VIOLATION REPORT
• Total Violations: ${state.violations.total}
• Tab Switching: ${state.violations.tabSwitching}
• App Switching: ${state.violations.appSwitching}
• High Typing Speed: ${state.violations.highTypingSpeed}
• Paste Detected: ${state.violations.pasteDetected}
• Rapid Keystrokes: ${state.violations.rapidKeystrokes}
• Final Warnings: ${state.warningCount}/${state.maxWarnings}

---
✅ Test automatically submitted and recorded
🕒 System Time: ${new Date().toLocaleString()}`;

      const testData = {
        studentName: state.studentName,
        teacherName: state.teacherName,
        violations: { ...state.violations, warningCount: state.warningCount },
        task1WordCount,
        task2WordCount,
        totalWords,
        testDuration
      };

      // Send to Telegram
      const telegramSuccess = await sendToTelegram(telegramMessage, testData);
      
      // Generate PDF
      downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount);
      
      // Update UI
      elements.loadingIndicator.style.display = 'none';
      state.isTestActive = false;
      state.isSubmitted = true;
      clearInterval(state.timer);
      
      elements.submitButton.style.display = 'none';
      elements.reviewButton.style.display = 'block';
      elements.submissionConfirmation.style.display = 'block';
      
      elements.textarea1.disabled = true;
      elements.textarea2.disabled = true;
      
      if (!telegramSuccess) {
        alert('Test submitted locally. Telegram notification failed - check console for details.');
      }
    }

    function reviewTest() {
      alert("You are now in review mode. You can read your answers but cannot make changes.");
    }

    function downloadPDF(task1Answer, task2Answer, task1WordCount, task2WordCount) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("IELTS Writing Test - Set Four", 10, 10);
      doc.setFontSize(12);
      doc.text(`Teacher: ${state.teacherName}`, 10, 20);
      doc.text(`Student: ${state.studentName}`, 10, 30);
      doc.text(`Timestamp: ${new Date().toLocaleString()}`, 10, 40);
      doc.text(`Violations: ${state.violations.total} (${state.warningCount}/2 warnings)`, 10, 50);
      
      doc.setFontSize(14);
      doc.text("IELTS Writing Task 1", 10, 65);
      doc.setFontSize(12);
      
      let yOffset = 75;
      if (state.chosenTask1.question) {
        const task1Lines = doc.splitTextToSize(state.chosenTask1.question.replace(/\n/g, " "), 180);
        doc.text(task1Lines, 10, yOffset);
        yOffset += task1Lines.length * 5 + 5;
      }
      
      if (state.task1ImageData) {
        const img = new Image();
        img.src = state.task1ImageData;
        img.onload = function() {
          const imgWidth = img.width;
          const imgHeight = img.height;
          const maxWidth = 180;
          const maxHeight = 80;
          let width = imgWidth;
          let height = imgHeight;

          if (width > maxWidth) {
            height = (maxWidth / width) * height;
            width = maxWidth;
          }
          if (height > maxHeight) {
            width = (maxHeight / height) * width;
            height = maxHeight;
          }

          doc.addImage(state.task1ImageData, "PNG", 10, yOffset, width, height);
          doc.text("Answer:", 10, yOffset + height + 10);
          const answerLines = doc.splitTextToSize(task1Answer, 180);
          doc.text(answerLines, 10, yOffset + height + 20);

          doc.addPage();
          doc.setFontSize(16);
          doc.text("IELTS Writing Test - Set Four", 10, 10);
          doc.setFontSize(12);
          doc.text(`Teacher: ${state.teacherName}`, 10, 20);
          doc.text(`Student: ${state.studentName}`, 10, 30);
          doc.text(`Violations: ${state.violations.total} (${state.warningCount}/2 warnings)`, 10, 40);
          doc.setFontSize(14);
          doc.text("IELTS Writing Task 2", 10, 55);
          doc.setFontSize(12);
          
          if (state.chosenTask2) {
            const task2Lines = doc.splitTextToSize(state.chosenTask2.replace(/\n/g, " "), 180);
            doc.text(task2Lines, 10, 65);
            doc.text("Answer:", 10, 95);
            const answer2Lines = doc.splitTextToSize(task2Answer, 180);
            doc.text(answer2Lines, 10, 105);
          }

          doc.save(`IELTS_Writing_${state.studentName.replace(/\s+/g, '_')}.pdf`);
        };
      } else {
        doc.text("Answer:", 10, yOffset);
        const answerLines = doc.splitTextToSize(task1Answer, 180);
        doc.text(answerLines, 10, yOffset + 10);

        doc.addPage();
        doc.setFontSize(16);
        doc.text("IELTS Writing Test - Set Four", 10, 10);
        doc.setFontSize(12);
        doc.text(`Teacher: ${state.teacherName}`, 10, 20);
        doc.text(`Student: ${state.studentName}`, 10, 30);
        doc.text(`Violations: ${state.violations.total} (${state.warningCount}/2 warnings)`, 10, 40);
        doc.setFontSize(14);
        doc.text("IELTS Writing Task 2", 10, 55);
        doc.setFontSize(12);
        
        if (state.chosenTask2) {
          const task2Lines = doc.splitTextToSize(state.chosenTask2.replace(/\n/g, " "), 180);
          doc.text(task2Lines, 10, 65);
          doc.text("Answer:", 10, 95);
          const answer2Lines = doc.splitTextToSize(task2Answer, 180);
          doc.text(answer2Lines, 10, 105);
        }

        doc.save(`IELTS_Writing_${state.studentName.replace(/\s+/g, '_')}.pdf`);
      }
    }

    function forceSubmit() {
      state.isTestActive = false;
      state.violationDetected = false;
      elements.warningModal.style.display = 'none';
      submitTest();
      clearInterval(state.timer);
    }

    // Page lifecycle management
    window.onbeforeunload = function (e) {
      if (state.isTestActive && !state.isSubmitted && !state.beforeUnloadTriggered) {
        const message = "Are you sure you want to leave? Your test progress may be lost.";
        e.returnValue = message;
        return message;
      }
    };

    window.addEventListener('unload', function() {
      if (state.isTestActive && !state.isSubmitted && !state.beforeUnloadTriggered) {
        state.beforeUnloadTriggered = true;
        submitTest();
      }
    });

    // Initialize the application
    window.addEventListener('load', initializeApp);
  </script>
</body>
</html>
